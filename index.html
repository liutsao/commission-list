<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â–æµè‰çš„å§”è¨—æ’å–®è¡¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* æ·±è‰²æ¨¡å¼æ¨£å¼ */
        body.dark-mode {
            background-color: #111827;
            color: #f3f4f6;
        }
        .dark-mode aside { background-color: #1f2937; border-color: #374151; }
        .dark-mode main { background-color: #111827; }
        .dark-mode header h1 { color: #ffffff; }
        .dark-mode .bg-white { background-color: #1f2937; border-color: #374151; }
        .dark-mode .text-gray-900 { color: #f3f4f6; }
        .dark-mode .text-gray-600 { color: #d1d5db; }
        .dark-mode .text-gray-500 { color: #9ca3af; }
        .dark-mode .bg-gray-50 { background-color: #374151; color: #e5e7eb; }
        .dark-mode border-b { border-color: #374151; }
        .dark-mode tr:hover { background-color: #2d3748; }
        .dark-mode input, .dark-mode select { background-color: #374151; border-color: #4b5563; color: white; }
        .dark-mode .border-gray-100 { border-color: #374151; }

        .blurred {
            filter: blur(5px);
            user-select: none;
            transition: filter 0.3s;
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-drawing { background-color: #dbeafe; color: #1e40af; }
        .status-checking { background-color: #f3e8ff; color: #6b21a8; }
        .status-delivered { background-color: #d1fae5; color: #065f46; }
        .status-completed { background-color: #e5e7eb; color: #374151; }
        .status-cancelled { background-color: #fee2e2; color: #991b1b; }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .btn-move {
            padding: 2px 6px;
            font-size: 12px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .btn-move:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .drag-over {
            border-top: 3px solid #6366f1 !important;
        }
    </style>
</head>
<body class="min-h-screen flex bg-gray-50 text-gray-800">

    <div id="loading" class="loading-overlay">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
    </div>

    <!-- å·¦å´é¸å–® -->
    <aside id="sidebar" class="w-64 bg-white border-r h-screen sticky top-0 hidden flex-col transition-colors duration-300">
        <div class="p-6 border-b border-gray-100">
            <h2 class="font-bold text-lg text-gray-800 dark:text-white">æ­·å²æ’å–®è¡¨</h2>
        </div>
        <div class="p-4 border-b border-gray-100">
            <button onclick="createBlankHistory()" class="w-full bg-gray-800 hover:bg-black text-white py-2 rounded-lg text-sm transition">
                + æ–°å¢æ­·å²è¡¨
            </button>
        </div>
        <div id="historyList" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
    </aside>

    <main class="flex-1 p-8 transition-colors duration-300">
        <header class="flex justify-between items-center mb-10">
            <div>
                <div class="flex items-center gap-4">
                    <h1 id="tableTitle" class="text-3xl font-bold text-gray-900">è¼‰å…¥ä¸­...</h1>
                    <button id="deleteHistoryBtn" onclick="deleteHistoryTable()" class="hidden bg-red-50 text-red-600 hover:bg-red-100 px-3 py-1 rounded text-sm transition">
                        åˆªé™¤æ­¤æ­·å²è¡¨
                    </button>
                </div>
                <p class="text-gray-500 mt-2">æœ€å¾Œæ›´æ–°ï¼š<span id="updateTime">---</span></p>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- æ·±è‰²æ¨¡å¼åˆ‡æ›æŒ‰éˆ• -->
                <button onclick="toggleDarkMode()" class="p-2 rounded-full border border-gray-200 bg-white hover:bg-gray-100 transition shadow-sm flex items-center justify-center w-10 h-10">
                    <span id="modeIcon">ğŸŒ™</span>
                </button>

                <div id="adminControls" class="hidden flex items-center gap-3">
                    <div class="bg-blue-50 px-4 py-2 rounded-lg border border-blue-100">
                        <span class="text-sm text-blue-600 font-medium">ç¸½é‡‘é¡ï¼š$</span>
                        <span id="totalAmount" class="text-blue-700 font-bold">0</span>
                    </div>
                    <button id="archiveBtn" onclick="archiveCurrentTable()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm transition">
                        å­˜å…¥æ­·å²ä¸¦æ–°å¢
                    </button>
                    <button onclick="logout()" class="text-gray-400 hover:text-red-500 transition">
                        é€€å‡ºç®¡ç†
                    </button>
                </div>
                <button id="loginBtn" onclick="promptLogin()" class="bg-white border border-gray-200 shadow-sm hover:shadow-md px-4 py-2 rounded-lg text-sm font-medium transition">
                    ç®¡ç†å“¡ç™»å…¥
                </button>
            </div>
        </header>

        <div class="bg-white shadow-sm border border-gray-100 rounded-xl overflow-hidden transition-colors duration-300">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <div id="editTitleSection" class="hidden flex-1 mr-4">
                    <input type="text" id="titleInput" class="w-full border p-2 rounded text-xl font-bold" placeholder="è¼¸å…¥æ’å–®è¡¨æ¨™é¡Œ...">
                </div>
                <div id="editActions" class="hidden">
                    <button onclick="addCommission()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                        <span>+</span> æ–°å¢å§”è¨—
                    </button>
                </div>
            </div>

            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-50 text-gray-600 text-sm uppercase">
                        <th class="p-4 font-semibold border-b">å§”è¨—äºº ID</th>
                        <th class="p-4 font-semibold border-b">ä¾†æº</th>
                        <th class="p-4 font-semibold border-b">é€²è¡Œç‹€æ…‹</th>
                        <th class="p-4 font-semibold border-b">å§”è¨—å…§å®¹</th>
                        <th class="p-4 font-semibold border-b text-right">å§”è¨—é‡‘é¡</th>
                        <th class="admin-only-header hidden p-4 font-semibold border-b text-center">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="commissionTableBody"></tbody>
            </table>
        </div>
    </main>

    <div id="customModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-xl w-80 dark:bg-gray-800">
            <h3 id="modalTitle" class="text-lg font-bold mb-4 dark:text-white">ç®¡ç†å“¡ç™»å…¥</h3>
            <input type="password" id="modalInput" class="w-full border p-2 rounded mb-4 dark:bg-gray-700 dark:text-white" placeholder="è«‹è¼¸å…¥å¯†ç¢¼...">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700">å–æ¶ˆ</button>
                <button id="modalConfirm" class="px-4 py-2 bg-blue-600 text-white rounded">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, addDoc, Timestamp, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /** * [é‡è¦] GitHub éƒ¨ç½²æ™‚å¡«å¯«ä½ çš„ Firebase Config
         */
        const firebaseConfig = {
            apiKey: "AIzaSyALtj1ceOZbR9xr7MpfU8lVf7HBKIbtuUU",
            authDomain: "commission-list-ba286.firebaseapp.com",
            projectId: "commission-list-ba286",
            storageBucket: "commission-list-ba286.firebasestorage.app",
            messagingSenderId: "242940980210",
            appId: "1:242940980210:web:a6e362652faac8775dd96b"
        };

        const finalConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : firebaseConfig;
        const app = initializeApp(finalConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const rawAppId = typeof __app_id !== 'undefined' ? __app_id : 'commission-system-v2';
        const appId = rawAppId.replace(/\./g, '_'); 

        let user = null;
        let isAdmin = false;
        let isDarkMode = false;
        let currentTableData = null;
        let historyData = [];
        let viewingTableId = 'current';
        let draggedId = null;
        let unsubscribeCurrent = null;
        let unsubscribeHistory = null;

        const startApp = async () => {
            try {
                let authResult;
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    authResult = await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    authResult = await signInAnonymously(auth);
                }
                user = authResult.user;
                if (user) setupRealtimeListeners();

                onAuthStateChanged(auth, (u) => {
                    const prevUser = user;
                    user = u;
                    if (user && !prevUser) setupRealtimeListeners();
                });
            } catch (err) {
                console.error("Auth Error:", err);
                document.getElementById('loading').innerHTML = `<div class='p-4 text-red-500 font-bold text-center'>é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase é…ç½®ã€‚</div>`;
            }
        };

        startApp();

        function setupRealtimeListeners() {
            if (!user) return;
            if (unsubscribeCurrent) unsubscribeCurrent();
            if (unsubscribeHistory) unsubscribeHistory();

            const currentDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'tables', 'current');
            unsubscribeCurrent = onSnapshot(currentDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentTableData = docSnap.data();
                } else {
                    currentTableData = { title: "æ–°å§”è¨—æ’å–®è¡¨", lastUpdate: new Date().toLocaleString(), commissions: [] };
                    saveCurrentToCloud();
                }
                if (viewingTableId === 'current') renderTable(currentTableData);
                document.getElementById('loading').classList.add('hidden');
            });

            const historyColRef = collection(db, 'artifacts', appId, 'public', 'data', 'history');
            unsubscribeHistory = onSnapshot(historyColRef, (querySnapshot) => {
                historyData = [];
                querySnapshot.forEach((doc) => historyData.push({ ...doc.data(), firebaseId: doc.id }));
                // æ‹–æ‹½æ’åºä¾æ“šï¼šorder æ¬„ä½ > æ™‚é–“
                historyData.sort((a, b) => (a.order || 0) - (b.order || 0));
                updateSidebar();
                if (viewingTableId !== 'current') {
                    const table = historyData.find(h => h.firebaseId === viewingTableId);
                    if (table) renderTable(table);
                    else { viewingTableId = 'current'; renderTable(currentTableData); }
                }
            });
        }

        // æ·±è‰²æ¨¡å¼åˆ‡æ›
        window.toggleDarkMode = function() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            document.getElementById('modeIcon').innerText = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™';
        };

        window.renderTable = function(data) {
            if (!data) return;
            const tbody = document.getElementById('commissionTableBody');
            const totalDisplay = document.getElementById('totalAmount');
            const titleDisplay = document.getElementById('tableTitle');
            const updateDisplay = document.getElementById('updateTime');
            const adminHeaders = document.querySelectorAll('.admin-only-header');
            const deleteHistoryBtn = document.getElementById('deleteHistoryBtn');
            const archiveBtn = document.getElementById('archiveBtn');

            tbody.innerHTML = '';
            titleDisplay.innerText = data.title;
            updateDisplay.innerText = data.lastUpdate;

            let total = 0;
            const isEditing = isAdmin;

            adminHeaders.forEach(h => isAdmin ? h.classList.remove('hidden') : h.classList.add('hidden'));
            
            if (isAdmin && viewingTableId !== 'current') {
                deleteHistoryBtn.classList.remove('hidden');
                archiveBtn.classList.add('hidden');
            } else {
                deleteHistoryBtn.classList.add('hidden');
                if (isAdmin) archiveBtn.classList.remove('hidden');
            }

            data.commissions.forEach((com, index) => {
                total += parseInt(com.price || 0);
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition border-b border-gray-100 last:border-0 dark:border-gray-700 dark:hover:bg-gray-800";
                
                let actionButtons = '-';
                if (isAdmin) {
                    actionButtons = `
                        <div class="flex items-center justify-center gap-2">
                            <button onclick="moveRow(${index}, -1)" ${index === 0 ? 'disabled' : ''} class="btn-move bg-gray-100 hover:bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-white">â–²</button>
                            <button onclick="moveRow(${index}, 1)" ${index === data.commissions.length - 1 ? 'disabled' : ''} class="btn-move bg-gray-100 hover:bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-white">â–¼</button>
                            <button onclick="deleteRow(${index})" class="text-red-400 hover:text-red-600 ml-2">åˆªé™¤</button>
                        </div>
                    `;
                }

                tr.innerHTML = `
                    <td class="p-4">${isEditing ? `<input type="text" value="${com.id}" onchange="updateRow(${index}, 'id', this.value)" class="border p-1 rounded w-full">` : `<span class="font-medium">${com.id}</span>`}</td>
                    <td class="p-4">${isEditing ? `<input type="text" value="${com.source}" onchange="updateRow(${index}, 'source', this.value)" class="border p-1 rounded w-full">` : com.source}</td>
                    <td class="p-4">${isEditing ? `<select onchange="updateRow(${index}, 'status', this.value)" class="border p-1 rounded w-full">${['å¾…ä»˜æ¬¾','ç¹ªè£½ä¸­','éœæ…‹ç¢ºèª','å·²äº¤ç¨¿','å·²å®Œæˆ','å–æ¶ˆæ’å–®'].map(s => `<option value="${s}" ${s === com.status ? 'selected' : ''}>${s}</option>`).join('')}</select>` : `<span class="status-badge ${getStatusClass(com.status)}">${com.status}</span>`}</td>
                    <td class="p-4 ${isAdmin ? '' : 'blurred'}">${isEditing ? `<input type="text" value="${com.content}" onchange="updateRow(${index}, 'content', this.value)" class="border p-1 rounded w-full">` : com.content}</td>
                    <td class="p-4 text-right font-mono ${isAdmin ? '' : 'blurred'}">${isEditing ? `<input type="number" value="${com.price}" onchange="updateRow(${index}, 'price', this.value)" class="border p-1 rounded w-24 text-right">` : `$${(com.price || 0).toLocaleString()}`}</td>
                    ${isAdmin ? `<td class="p-4 text-center">${actionButtons}</td>` : ''}
                `;
                tbody.appendChild(tr);
            });
            totalDisplay.innerText = total.toLocaleString();
        };

        window.moveRow = function(index, direction) {
            if (!isAdmin) return;
            const targetData = viewingTableId === 'current' ? currentTableData : historyData.find(h => h.firebaseId === viewingTableId);
            if (!targetData) return;
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= targetData.commissions.length) return;
            const temp = targetData.commissions[index];
            targetData.commissions[index] = targetData.commissions[newIndex];
            targetData.commissions[newIndex] = temp;
            targetData.lastUpdate = new Date().toLocaleString() + (viewingTableId === 'current' ? "" : " (å·²ç·¨è¼¯)");
            saveSpecificTableToCloud(viewingTableId, targetData);
        };

        async function saveSpecificTableToCloud(id, data) {
            if (!user || !data) return;
            const docRef = (id === 'current') 
                ? doc(db, 'artifacts', appId, 'public', 'data', 'tables', 'current')
                : doc(db, 'artifacts', appId, 'public', 'data', 'history', id);
            const uploadData = { ...data };
            if (uploadData.firebaseId) delete uploadData.firebaseId;
            await setDoc(docRef, uploadData);
        }

        window.updateRow = function(index, field, value) {
            if (!isAdmin) return;
            const targetData = viewingTableId === 'current' ? currentTableData : historyData.find(h => h.firebaseId === viewingTableId);
            if (!targetData) return;
            targetData.commissions[index][field] = field === 'price' ? parseInt(value) || 0 : value;
            targetData.lastUpdate = new Date().toLocaleString() + (viewingTableId === 'current' ? "" : " (å·²ç·¨è¼¯)");
            saveSpecificTableToCloud(viewingTableId, targetData);
        };

        window.addCommission = function() {
            if (!isAdmin) return;
            const targetData = viewingTableId === 'current' ? currentTableData : historyData.find(h => h.firebaseId === viewingTableId);
            if (!targetData) return;
            targetData.commissions.push({ id: 'æ–°å§”è¨—äºº', source: '-', status: 'å¾…ä»˜æ¬¾', content: 'ç„¡', price: 0 });
            saveSpecificTableToCloud(viewingTableId, targetData);
        };

        window.deleteRow = function(index) {
            if (!isAdmin || !confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            const targetData = viewingTableId === 'current' ? currentTableData : historyData.find(h => h.firebaseId === viewingTableId);
            if (!targetData) return;
            targetData.commissions.splice(index, 1);
            saveSpecificTableToCloud(viewingTableId, targetData);
        };

        window.deleteHistoryTable = async function() {
            if (!isAdmin || viewingTableId === 'current' || !confirm('è­¦å‘Šï¼šç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™å¼µæ­·å²æ’å–®è¡¨å—ï¼Ÿ')) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'history', viewingTableId);
            await deleteDoc(docRef);
            viewingTableId = 'current';
            toggleAdminUI();
            alert('å·²åˆªé™¤æ­·å²ç´€éŒ„');
        };

        window.createBlankHistory = async function() {
            if (!isAdmin) return;
            const historyColRef = collection(db, 'artifacts', appId, 'public', 'data', 'history');
            const nextOrder = historyData.length > 0 ? Math.max(...historyData.map(h => h.order || 0)) + 1 : 0;
            const newDoc = await addDoc(historyColRef, {
                title: "æ‰‹å‹•æ–°å¢æ’å–®è¡¨",
                lastUpdate: new Date().toLocaleString(),
                archivedAt: Timestamp.now(),
                order: nextOrder,
                commissions: []
            });
            viewingTableId = newDoc.id;
            toggleAdminUI();
        };

        document.getElementById('titleInput').oninput = (e) => {
            if (!isAdmin) return;
            const targetData = viewingTableId === 'current' ? currentTableData : historyData.find(h => h.firebaseId === viewingTableId);
            if (!targetData) return;
            targetData.title = e.target.value;
            saveSpecificTableToCloud(viewingTableId, targetData);
        };

        window.archiveCurrentTable = async function() {
            if (!isAdmin || !confirm('ç¢ºå®šå­˜å…¥æ­·å²ä¸¦æ¸…ç©ºç•¶å‰æ’å–®ï¼Ÿ')) return;
            const historyColRef = collection(db, 'artifacts', appId, 'public', 'data', 'history');
            const nextOrder = historyData.length > 0 ? Math.max(...historyData.map(h => h.order || 0)) + 1 : 0;
            await addDoc(historyColRef, { ...currentTableData, archivedAt: Timestamp.now(), order: nextOrder });
            currentTableData = { title: "æ–°å§”è¨—æ’å–®è¡¨ (" + new Date().toLocaleDateString() + ")", lastUpdate: new Date().toLocaleString(), commissions: [] };
            await saveCurrentToCloud();
            alert('å·²æˆåŠŸå­˜æª”');
        };

        async function saveCurrentToCloud() { await saveSpecificTableToCloud('current', currentTableData); }

        function getStatusClass(status) {
            const classes = { 'å¾…ä»˜æ¬¾': 'status-pending', 'ç¹ªè£½ä¸­': 'status-drawing', 'éœæ…‹ç¢ºèª': 'status-checking', 'å·²äº¤ç¨¿': 'status-delivered', 'å·²å®Œæˆ': 'status-completed', 'å–æ¶ˆæ’å–®': 'status-cancelled' };
            return classes[status] || '';
        }

        window.promptLogin = function() {
            document.getElementById('modalInput').value = '';
            document.getElementById('customModal').classList.remove('hidden');
            document.getElementById('modalConfirm').onclick = () => {
                if(document.getElementById('modalInput').value === "kk7680771") {
                    isAdmin = true;
                    toggleAdminUI();
                    closeModal();
                } else { alert('å¯†ç¢¼éŒ¯èª¤'); }
            };
        };

        window.logout = function() { isAdmin = false; viewingTableId = 'current'; toggleAdminUI(); };
        window.closeModal = () => document.getElementById('customModal').classList.add('hidden');

        function toggleAdminUI() {
            const adminControls = document.getElementById('adminControls');
            const loginBtn = document.getElementById('loginBtn');
            const sidebar = document.getElementById('sidebar');
            const editActions = document.getElementById('editActions');
            const editTitleSection = document.getElementById('editTitleSection');
            const tableTitle = document.getElementById('tableTitle');
            const titleInput = document.getElementById('titleInput');

            if (isAdmin) {
                adminControls.classList.remove('hidden'); loginBtn.classList.add('hidden');
                sidebar.classList.remove('hidden'); sidebar.classList.add('flex');
                editActions.classList.remove('hidden'); editTitleSection.classList.remove('hidden');
                tableTitle.classList.add('hidden');
                const targetData = viewingTableId === 'current' ? currentTableData : historyData.find(h => h.firebaseId === viewingTableId);
                if (targetData) titleInput.value = targetData.title;
            } else {
                adminControls.classList.add('hidden'); loginBtn.classList.remove('hidden');
                sidebar.classList.add('hidden'); editActions.classList.add('hidden');
                editTitleSection.classList.add('hidden'); tableTitle.classList.remove('hidden');
            }
            renderTable(viewingTableId === 'current' ? currentTableData : historyData.find(h => h.firebaseId === viewingTableId));
            updateSidebar(); // åˆ·æ–°æ‹–æ‹½ç‹€æ…‹
        }

        // å´é‚Šæ¬„æ‹–æ‹½æ’åºé‚è¼¯
        function updateSidebar() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            
            // ç›®å‰æ’å–® (ä¸å¯æ‹–æ‹½)
            const currentBtn = document.createElement('button');
            currentBtn.className = `w-full text-left p-3 rounded-lg font-medium text-sm border transition ${viewingTableId === 'current' ? 'bg-blue-50 text-blue-700 border-blue-100' : 'hover:bg-gray-100 text-gray-600 border-transparent dark:text-gray-300 dark:hover:bg-gray-700'}`;
            currentBtn.innerText = "â–¸ ç›®å‰æ’å–®";
            currentBtn.onclick = () => { viewingTableId = 'current'; toggleAdminUI(); };
            list.appendChild(currentBtn);

            // æ­·å²è¡¨ (å¯æ‹–æ‹½)
            historyData.forEach((item, index) => {
                const btn = document.createElement('div');
                btn.className = `w-full text-left p-3 rounded-lg text-sm transition border cursor-pointer ${viewingTableId === item.firebaseId ? 'bg-indigo-50 text-indigo-700 border-indigo-100' : 'hover:bg-gray-100 text-gray-600 border-transparent dark:text-gray-300 dark:hover:bg-gray-700'}`;
                btn.innerText = item.title;
                btn.onclick = () => { viewingTableId = item.firebaseId; toggleAdminUI(); };

                if (isAdmin) {
                    btn.setAttribute('draggable', 'true');
                    btn.ondragstart = (e) => {
                        draggedId = item.firebaseId;
                        e.dataTransfer.effectAllowed = "move";
                        btn.style.opacity = "0.5";
                    };
                    btn.ondragend = () => {
                        btn.style.opacity = "1";
                        draggedId = null;
                        const allItems = list.querySelectorAll('[draggable]');
                        allItems.forEach(i => i.classList.remove('drag-over'));
                    };
                    btn.ondragover = (e) => {
                        e.preventDefault();
                        if (draggedId !== item.firebaseId) btn.classList.add('drag-over');
                    };
                    btn.ondragleave = () => btn.classList.remove('drag-over');
                    btn.ondrop = async (e) => {
                        e.preventDefault();
                        if (draggedId && draggedId !== item.firebaseId) {
                            await reorderHistory(draggedId, item.firebaseId);
                        }
                    };
                }
                list.appendChild(btn);
            });
        }

        // é‡æ–°æ’åºé›²ç«¯æ•¸æ“š
        async function reorderHistory(sourceId, targetId) {
            const sourceItem = historyData.find(h => h.firebaseId === sourceId);
            const targetItem = historyData.find(h => h.firebaseId === targetId);
            if (!sourceItem || !targetItem) return;

            const batch = writeBatch(db);
            const sourceRef = doc(db, 'artifacts', appId, 'public', 'data', 'history', sourceId);
            const targetRef = doc(db, 'artifacts', appId, 'public', 'data', 'history', targetId);

            const tempOrder = sourceItem.order || 0;
            batch.update(sourceRef, { order: targetItem.order || 0 });
            batch.update(targetRef, { order: tempOrder });

            await batch.commit();
        }
    </script>
</body>
</html>