<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>▍流草-委託排單表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
        }

        .blurred {
            filter: blur(5px);
            user-select: none;
            transition: filter 0.3s;
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-drawing { background-color: #dbeafe; color: #1e40af; }
        .status-checking { background-color: #f3e8ff; color: #6b21a8; }
        .status-delivered { background-color: #d1fae5; color: #065f46; }
        .status-completed { background-color: #e5e7eb; color: #374151; }
        .status-cancelled { background-color: #fee2e2; color: #991b1b; }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .source-link {
            background-color: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            text-decoration: none;
            color: inherit;
            transition: background-color 0.2s;
        }
        .source-link:hover {
            background-color: #e5e7eb;
        }

        .drag-over {
            border-top: 3px solid #6366f1 !important;
        }
    </style>
</head>
<body class="min-h-screen flex">

    <div id="loading" class="loading-overlay">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
    </div>

    <!-- 左側選單 -->
    <aside id="sidebar" class="w-64 bg-white border-r h-screen sticky top-0 hidden flex-col">
        <div class="p-6 border-b">
            <h2 class="font-bold text-lg text-gray-800">歷史排單表</h2>
        </div>
        <div class="p-4 border-b">
            <button onclick="createBlankHistory()" class="w-full bg-gray-800 hover:bg-black text-white py-2 rounded-lg text-sm transition">
                + 新增歷史表
            </button>
        </div>
        <div id="historyList" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
    </aside>

    <!-- 主要內容區 -->
    <main class="flex-1 p-8 lg:p-12 max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-10">
            <div>
                <div class="flex items-center gap-4">
                    <h1 id="tableTitle" class="text-3xl font-bold text-gray-900">載入中...</h1>
                    <button id="deleteHistoryBtn" onclick="deleteHistoryTable()" class="hidden bg-red-50 text-red-600 hover:bg-red-100 px-3 py-1 rounded text-sm transition">
                        刪除此歷史表
                    </button>
                </div>
                <p class="text-gray-500 mt-2">最後更新時間：<span id="updateTime">---</span></p>
            </div>
            
            <div class="flex items-center gap-4">
                <div id="adminControls" class="hidden flex items-center gap-3">
                    <div class="bg-blue-50 px-4 py-2 rounded-lg border border-blue-100">
                        <span class="text-sm text-blue-600 font-medium">總金額：$</span>
                        <span id="totalAmount" class="text-blue-700 font-bold">0</span>
                    </div>
                    <button id="archiveBtn" onclick="archiveCurrentTable()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm transition">
                        存入歷史並新增
                    </button>
                    <button onclick="logout()" class="text-gray-400 hover:text-red-500 transition">
                        退出管理
                    </button>
                </div>
                <button id="loginBtn" onclick="promptLogin()" class="bg-white border border-gray-200 shadow-sm hover:shadow-md px-4 py-2 rounded-lg text-sm font-medium transition">
                    管理員登入
                </button>
            </div>
        </header>

        <div class="bg-white shadow-sm border border-gray-100 rounded-xl overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center">
                <div id="editTitleSection" class="hidden flex-1 mr-4">
                    <input type="text" id="titleInput" class="w-full border p-2 rounded text-xl font-bold" placeholder="輸入排單表標題...">
                </div>
                <div id="editActions" class="hidden">
                    <button onclick="addCommission()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                        <span>+</span> 新增委託
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 text-sm uppercase">
                            <th class="p-4 font-semibold border-b">委託人 ID</th>
                            <th class="p-4 font-semibold border-b">來源</th>
                            <th class="p-4 font-semibold border-b">進行狀態</th>
                            <th class="p-4 font-semibold border-b">委託內容</th>
                            <th class="p-4 font-semibold border-b text-right">委託金額</th>
                            <th class="admin-only hidden p-4 font-semibold border-b text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="commissionTableBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="customModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-xl w-80">
            <h3 id="modalTitle" class="text-lg font-bold mb-4">管理員登入</h3>
            <input type="password" id="modalInput" class="w-full border p-2 rounded mb-4" placeholder="請輸入密碼...">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700">取消</button>
                <button id="modalConfirm" class="px-4 py-2 bg-blue-600 text-white rounded">確認</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, addDoc, Timestamp, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase 配置
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyALtj1ceOZbR9xr7MpfU8lVf7HBKIbtuUU",
            authDomain: "commission-list-ba286.firebaseapp.com",
            projectId: "commission-list-ba286",
            storageBucket: "commission-list-ba286.firebasestorage.app",
            messagingSenderId: "242940980210",
            appId: "1:242940980210:web:a6e362652faac8775dd96b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-commission-app';

        // 全域變數
        let user = null;
        let isAdmin = false;
        let currentTableData = null;
        let historyData = [];
        let viewingTableId = 'current';
        let draggedId = null;

        // 初始化驗證
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        initAuth();

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) setupListeners();
        });

        // 監聽數據
        function setupListeners() {
            if (!user) return;

            // 監聽目前排單
            const currentDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'tables', 'current');
            onSnapshot(currentDocRef, (snap) => {
                if (snap.exists()) {
                    currentTableData = snap.data();
                    // 資料格式相容處理
                    currentTableData.commissions.forEach(c => {
                        if (typeof c.source === 'string') c.source = { text: c.source, link: '' };
                    });
                } else {
                    currentTableData = { title: "2024年 委託排單表", lastUpdate: new Date().toLocaleString(), commissions: [] };
                    saveTable('current', currentTableData);
                }
                if (viewingTableId === 'current') renderTable(currentTableData);
                document.getElementById('loading').classList.add('hidden');
            });

            // 監聽歷史紀錄
            const historyColRef = collection(db, 'artifacts', appId, 'public', 'data', 'history');
            onSnapshot(historyColRef, (snap) => {
                historyData = snap.docs.map(d => ({ ...d.data(), firebaseId: d.id }));
                historyData.sort((a, b) => (a.order || 0) - (b.order || 0));
                updateSidebar();
                if (viewingTableId !== 'current') {
                    const table = historyData.find(h => h.firebaseId === viewingTableId);
                    if (table) renderTable(table);
                }
            });
        }

        // 渲染表格
        window.renderTable = function(data) {
            const tbody = document.getElementById('commissionTableBody');
            const totalDisplay = document.getElementById('totalAmount');
            const titleDisplay = document.getElementById('tableTitle');
            const updateDisplay = document.getElementById('updateTime');
            const deleteBtn = document.getElementById('deleteHistoryBtn');
            const archiveBtn = document.getElementById('archiveBtn');

            tbody.innerHTML = '';
            titleDisplay.innerText = data.title;
            updateDisplay.innerText = data.lastUpdate;

            let total = 0;

            if (isAdmin && viewingTableId !== 'current') {
                deleteBtn.classList.remove('hidden');
                archiveBtn.classList.add('hidden');
            } else {
                deleteBtn.classList.add('hidden');
                if (isAdmin) archiveBtn.classList.remove('hidden');
            }

            data.commissions.forEach((com, index) => {
                total += parseInt(com.price || 0);
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition border-b border-gray-100 last:border-0";
                
                let sourceHTML = '';
                if (isAdmin) {
                    sourceHTML = `
                        <div class="space-y-1">
                            <input type="text" value="${com.source.text || ''}" onchange="updateSource(${index}, 'text', this.value)" class="border p-1 rounded w-full text-xs" placeholder="顯示文字">
                            <input type="text" value="${com.source.link || ''}" onchange="updateSource(${index}, 'link', this.value)" class="border p-1 rounded w-full text-xs" placeholder="連結網址">
                        </div>
                    `;
                } else {
                    if (com.source.link) {
                        sourceHTML = `<a href="${com.source.link}" target="_blank" class="source-link text-sm font-medium">${com.source.text || '連結'}</a>`;
                    } else {
                        sourceHTML = `<span class="text-sm text-gray-600">${com.source.text || '-'}</span>`;
                    }
                }

                tr.innerHTML = `
                    <td class="p-4">${isAdmin ? `<input type="text" value="${com.id}" onchange="updateData(${index}, 'id', this.value)" class="border p-1 rounded w-full">` : `<span class="font-medium">${com.id}</span>`}</td>
                    <td class="p-4">${sourceHTML}</td>
                    <td class="p-4">
                        ${isAdmin ? `<select onchange="updateData(${index}, 'status', this.value)" class="border p-1 rounded w-full">
                            ${['待付款','繪製中','靜態確認','已交稿','已完成','取消排單'].map(s => `<option value="${s}" ${s === com.status ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>` : `<span class="status-badge ${getStatusClass(com.status)}">${com.status}</span>`}
                    </td>
                    <td class="p-4 ${isAdmin ? '' : 'blurred'}">${isAdmin ? `<input type="text" value="${com.content}" onchange="updateData(${index}, 'content', this.value)" class="border p-1 rounded w-full">` : com.content}</td>
                    <td class="p-4 text-right font-mono ${isAdmin ? '' : 'blurred'}">${isAdmin ? `<input type="number" value="${com.price}" onchange="updateData(${index}, 'price', this.value)" class="border p-1 rounded w-24 text-right">` : `$${com.price.toLocaleString()}`}</td>
                    ${isAdmin ? `
                        <td class="p-4 text-center">
                            <div class="flex flex-col gap-1 items-center">
                                <div class="flex gap-1">
                                    <button onclick="moveRow(${index}, -1)" class="w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-gray-200 rounded text-gray-600 ${index === 0 ? 'invisible' : ''}" title="上移">▲</button>
                                    <button onclick="moveRow(${index}, 1)" class="w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-gray-200 rounded text-gray-600 ${index === data.commissions.length - 1 ? 'invisible' : ''}" title="下移">▼</button>
                                </div>
                                <button onclick="deleteRow(${index})" class="text-xs text-red-400 hover:text-red-600 mt-1">刪除</button>
                            </div>
                        </td>
                    ` : ''}
                `;
                tbody.appendChild(tr);
            });
            totalDisplay.innerText = total.toLocaleString();
        };

        // 資料同步函數
        async function saveTable(id, data) {
            if (!user) return;
            const docRef = id === 'current' 
                ? doc(db, 'artifacts', appId, 'public', 'data', 'tables', 'current')
                : doc(db, 'artifacts', appId, 'public', 'data', 'history', id);
            const dataToSave = { ...data };
            delete dataToSave.firebaseId;
            await setDoc(docRef, dataToSave);
        }

        window.updateData = function(index, field, value) {
            const table = viewingTableId === 'current' ? currentTableData : historyData.find(h => h.firebaseId === viewingTableId);
            table.commissions[index][field] = field === 'price' ? parseInt(value) || 0 : value;
            table.lastUpdate = new Date().toLocaleString();
            saveTable(viewingTableId, table);
        };

        window.updateSource = function(index, subfield, value) {
            const table = viewingTableId === 'current' ? currentTableData : historyData.find(h => h.firebaseId === viewingTableId);
            table.commissions[index].source[subfield] = value;
            table.lastUpdate = new Date().toLocaleString();
            saveTable(viewingTableId, table);
        };

        window.addCommission = function() {
            const table = viewingTableId === 'current' ? currentTableData : historyData.find(h => h.firebaseId === viewingTableId);
            table.commissions.push({ id: '新委託', source: { text: '-', link: '' }, status: '待付款', content: '無', price: 0 });
            saveTable(viewingTableId, table);
        };

        window.deleteRow = function(index) {
            if(!confirm('刪除此行？')) return;
            const table = viewingTableId === 'current' ? currentTableData : historyData.find(h => h.firebaseId === viewingTableId);
            table.commissions.splice(index, 1);
            saveTable(viewingTableId, table);
        };

        // 新增：上移/下移功能
        window.moveRow = function(index, direction) {
            const table = viewingTableId === 'current' ? currentTableData : historyData.find(h => h.firebaseId === viewingTableId);
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= table.commissions.length) return;

            // 交換陣列元素
            [table.commissions[index], table.commissions[newIndex]] = [table.commissions[newIndex], table.commissions[index]];
            
            table.lastUpdate = new Date().toLocaleString();
            saveTable(viewingTableId, table);
        };

        window.archiveCurrentTable = async function() {
            if(!confirm('存入歷史並重置目前排單？')) return;
            const historyCol = collection(db, 'artifacts', appId, 'public', 'data', 'history');
            await addDoc(historyCol, { ...currentTableData, order: historyData.length, archivedAt: Timestamp.now() });
            currentTableData = { title: "新排單表", lastUpdate: new Date().toLocaleString(), commissions: [] };
            saveTable('current', currentTableData);
        };

        window.deleteHistoryTable = async function() {
            if(!confirm('永久刪除此歷史表？')) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'history', viewingTableId));
            viewingTableId = 'current';
            toggleAdminUI();
        };

        window.createBlankHistory = async function() {
            const historyCol = collection(db, 'artifacts', appId, 'public', 'data', 'history');
            await addDoc(historyCol, { title: "手動新增歷史表", lastUpdate: new Date().toLocaleString(), order: historyData.length, commissions: [] });
        };

        // UI 邏輯
        window.promptLogin = function() {
            document.getElementById('modalInput').value = '';
            document.getElementById('customModal').classList.remove('hidden');
            document.getElementById('modalConfirm').onclick = () => {
                if(document.getElementById('modalInput').value === "kk7680771") {
                    isAdmin = true;
                    toggleAdminUI();
                    closeModal();
                } else { alert('密碼錯誤'); }
            };
        };

        window.logout = function() { isAdmin = false; viewingTableId = 'current'; toggleAdminUI(); };
        window.closeModal = () => document.getElementById('customModal').classList.add('hidden');

        function toggleAdminUI() {
            const adminControls = document.getElementById('adminControls');
            const loginBtn = document.getElementById('loginBtn');
            const sidebar = document.getElementById('sidebar');
            const editActions = document.getElementById('editActions');
            const editTitleSection = document.getElementById('editTitleSection');
            const tableTitle = document.getElementById('tableTitle');
            const adminCols = document.querySelectorAll('.admin-only');

            if (isAdmin) {
                adminControls.classList.remove('hidden'); loginBtn.classList.add('hidden');
                sidebar.classList.remove('hidden'); sidebar.classList.add('flex');
                editActions.classList.remove('hidden'); editTitleSection.classList.remove('hidden');
                tableTitle.classList.add('hidden');
                adminCols.forEach(el => el.classList.remove('hidden'));
                const table = viewingTableId === 'current' ? currentTableData : historyData.find(h => h.firebaseId === viewingTableId);
                document.getElementById('titleInput').value = table.title;
            } else {
                adminControls.classList.add('hidden'); loginBtn.classList.remove('hidden');
                sidebar.classList.add('hidden'); editActions.classList.add('hidden');
                editTitleSection.classList.add('hidden'); tableTitle.classList.remove('hidden');
                adminCols.forEach(el => el.classList.add('hidden'));
            }
            renderTable(viewingTableId === 'current' ? currentTableData : historyData.find(h => h.firebaseId === viewingTableId));
        }

        document.getElementById('titleInput').oninput = (e) => {
            const table = viewingTableId === 'current' ? currentTableData : historyData.find(h => h.firebaseId === viewingTableId);
            table.title = e.target.value;
            saveTable(viewingTableId, table);
        };

        function updateSidebar() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            
            const currentBtn = document.createElement('button');
            currentBtn.className = `w-full text-left p-3 rounded-lg font-medium text-sm border transition ${viewingTableId === 'current' ? 'bg-blue-50 text-blue-700 border-blue-100' : 'hover:bg-gray-100 text-gray-600 border-transparent'}`;
            currentBtn.innerText = "▸ 目前排單";
            currentBtn.onclick = () => { viewingTableId = 'current'; toggleAdminUI(); };
            list.appendChild(currentBtn);

            historyData.forEach((item) => {
                const btn = document.createElement('div');
                btn.className = `w-full text-left p-3 rounded-lg text-sm transition border cursor-pointer ${viewingTableId === item.firebaseId ? 'bg-indigo-50 text-indigo-700 border-indigo-100' : 'hover:bg-gray-100 text-gray-600 border-transparent'}`;
                btn.innerText = item.title;
                btn.onclick = () => { viewingTableId = item.firebaseId; toggleAdminUI(); };

                if (isAdmin) {
                    btn.draggable = true;
                    btn.ondragstart = (e) => draggedId = item.firebaseId;
                    btn.ondragover = (e) => { e.preventDefault(); btn.classList.add('drag-over'); };
                    btn.ondragleave = () => btn.classList.remove('drag-over');
                    btn.ondrop = async (e) => {
                        btn.classList.remove('drag-over');
                        if (draggedId && draggedId !== item.firebaseId) await reorderHistory(draggedId, item.firebaseId);
                    };
                }
                list.appendChild(btn);
            });
        }

        async function reorderHistory(sourceId, targetId) {
            const source = historyData.find(h => h.firebaseId === sourceId);
            const target = historyData.find(h => h.firebaseId === targetId);
            const batch = writeBatch(db);
            const tempOrder = source.order;
            batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'history', sourceId), { order: target.order });
            batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'history', targetId), { order: tempOrder });
            await batch.commit();
        }

        function getStatusClass(status) {
            const map = { '待付款': 'status-pending', '繪製中': 'status-drawing', '靜態確認': 'status-checking', '已交稿': 'status-delivered', '已完成': 'status-completed', '取消排單': 'status-cancelled' };
            return map[status] || '';
        }
    </script>
</body>
</html>